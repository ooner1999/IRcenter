<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>People by degree</title>
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>

    <style type="text/css">
        
        .node:hover {
            fill-opacity: 29;
            stroke: white;
            stroke-width: 1px;
        }

        div.tooltip-bubble {
            position: absolute;
            text-align: center;
            padding: .5rem;
            background: whitesmoke;
            color: #313639;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            font-size: 1.0rem;
        }
    </style>
</head>

<body>
    <div>
        <input type="checkbox" name="chk_type" value=1 checked="checked" onclick="check()">학사 </br>
        <input type="checkbox" name="chk_type" value=2 checked="checked" onclick="check()">석사 </br>
        <input type="checkbox" name="chk_type" value=3 checked="checked" onclick="check()">박사 </br>
    </div>
    <div>
        <input type="radio" name="chk_year" value="2019" checked="checked" onclick="check()">2019
        <input type="radio" name="chk_year" value="2018" onclick="check()">2018
        <input type="radio" name="chk_year" value="2017" onclick="check()">2017
        <input type="radio" name="chk_year" value="2016" onclick="check()">2016
        <input type="radio" name="chk_year" value="2015" onclick="check()">2015
        <input type="radio" name="chk_year" value="2014" onclick="check()">2014
        <input type="radio" name="chk_year" value="2013" onclick="check()">2013
        <input type="radio" name="chk_year" value="2012" onclick="check()">2012
        <input type="radio" name="chk_year" value="2011" onclick="check()">2011
        <input type="radio" name="chk_year" value="2010" onclick="check()">2010
    </div>
    <!-- <div>
        <input type="radio" name="chk_one" value="2019" checked="checked" onclick="check()">default
        <input type="radio" name="chk_one" value="2019" onclick="check()">pick one
    </div> -->

    <script type="text/javascript">
        function parse(callback, year) {
            if (year <= 2018) year = 2018
            $.getJSON("../data/degree/json/" + String(year) + "_dgree_by_major.json", (json) => {
                //console.log(json)
                callback(json)
            })
        }

        function check() {
            var val = document.getElementsByName("chk_type");
            var type = [0, 0, 0]
            var year = 0
            for (var i = 0; i < val.length; i++) {
                if (val[i].checked) {
                    console.log(val[i].value + "체크")
                    type[i] = Number(val[i].value)
                }
                else console.log(val[i].value + "안체크")
            }

            var y = document.getElementsByName("chk_year");
            for (var i = 0; i < y.length; i++)
                if (y[i].checked) {
                    console.log(y[i].value)
                    year = y[i].value
                    continue
                }
            calld3(type, year)
        }


        function calld3(type, year) {
            parse(json => {
                //console.log(json)
                var dataset = new Object();
                var children_array = new Array();
                for (var i = 0; i < json.length; ++i) {
                    if (type[0] == 1) {
                        tmp = new Object();
                        tmp["Name"] = json[i]["category"] + " 학사";
                        tmp["Count"] =  json[i]["bachelor"]
                        if(tmp["Count"])
                            children_array.push(tmp)
                    }
                    if (type[1] == 2) {
                        tmp = new Object();
                        tmp["Name"] = json[i]["category"] + " 석사";
                        tmp["Count"] =  json[i]["master"];
                        if(tmp["Count"])
                            children_array.push(tmp)
                    }
                    if (type[2] == 3) {
                        tmp = new Object();
                        tmp["Name"] = json[i]["category"] + " 박사";
                        tmp["Count"] =  json[i]["doctor"];
                        if(tmp["Count"])
                            children_array.push(tmp)
                    }
                }
                
                children_array.sort((a,b)=>(a.Count > b.Count) ? -1 : ((b.Count > a.Count ? 1 : 0)))
                etc = {"Name" : "그 외", "Count" : 0};
                for(var i=30;i<children_array.length;++i){
                    etc["Count"] += children_array[i]["Count"];
                }
                children_array = children_array.slice(0,30);
                children_array.push(etc)
                
                dataset["children"] = children_array
                console.log(dataset)
                d3.select("svg").remove();
                var diameter = 600;
                var color = d3.scaleOrdinal(d3.schemeCategory20);

                var bubble = d3.pack(dataset)
                    .size([diameter, diameter])
                    .padding(1.5);

                var svg = d3.select("body")
                    .append("svg")
                    .attr("width", diameter)
                    .attr("height", diameter)
                    .attr("class", "bubble");

                var nodes = d3.hierarchy(dataset)
                    .sum(function (d) { return d.Count; });

                var div = d3.select("body").append("div")
                    .attr("class", "tooltip-bubble")
                    .style("opacity", 0)

                var node = svg.selectAll(".node")
                    .data(bubble(nodes).descendants())
                    .enter()
                    .filter(function (d) { return !d.children })
                    .append("g")
                    .attr("class", "node")
                    .attr("opacity",'.4')
                    .attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    })
                    .on("mouseover", function (d, i) {
                        d3.select(this).transition()
                            .duration('50')
                            .attr("opacity", '1')
                        div.transition()
                            .duration(50)
                            .style("opacity", 1)
                        div.html("학문 : " + d.data.Name + "</br>" + "인원 : " + d.data.Count)
                            .style("left", (d3.event.pageX + 10) + "px")
                            .style("top", (d3.event.pageY - 10) + "px")
                    })
                    .on("mouseout", function (d, i) {
                        d3.select(this).transition()
                            .duration('50')
                            .attr('opacity', '.4')
                        div.transition()
                            .duration('50')
                            .style("opacity", 0)
                    })

                // node.append("title")
                //     .text(function (d) {return d.Name + ": " + d.Count});

                node.append("circle")
                    .attr("r", function (d) { return d.r })
                    .style("fill", function (d, i) { return color(i) });

                node.append("text")
                    .attr("dy", ".2em")
                    .style("text-anchor", "middle")
                    .text(function (d) {
                        return d.data.Name.substring(0, d.r / 3);
                    })
                    .attr("font-family", "sans-serif")
                    .attr("font-size", function (d) { return d.r / 5 })
                    .attr("fill", "white");

                // node.append("text")
                //     .attr("dy", "1.3em")
                //     .style("text-anchor", "middle")
                //     .text(function (d) {
                //         return d.data.Count;
                //     })
                //     .attr("font-family", "Gill Sans", "Gill Sans MT")
                //     .attr("font-size", function (d) {
                //         return d.r / 5;
                //     })
                //     .attr("fill", "white");

                d3.select(self.frameElement)
                    .style("height", diameter + "px");

            }, year)
        };
        check()
    </script>
</body>

</html>